# Chapter 3 – Advanced EIGRP  

---

# 1. Failure Detection and Timers

EIGRP utiliza mecanismos para detectar fallas rápidamente y así acelerar la convergencia. Los dos principales son:

### ● Hello Timer
Intervalo en el cual un router EIGRP envía mensajes Hello a sus vecinos.

Valores típicos:
- 5 segundos en enlaces broadcast / punto a punto.
- 60 segundos en enlaces NBMA (T1 Frame Relay antiguo, DMVPN fase 2/3 sin ajuste).

Verificación:
```
show ip eigrp interfaces
show ip eigrp neighbors
```

### ● Hold Timer
Tiempo máximo que puede pasar sin recibir Hellos antes de declarar al vecino como caído.

Generalmente es **tres veces el Hello**.

Configuración manual:
```
interface GigabitEthernet0/0
 ip hello-interval eigrp 100 1
 ip hold-time eigrp 100 3
```

Nota de certificación:
- No es necesario que los valores de los timers coincidan entre vecinos.
- Pero si están muy ajustados, puede provocar falsos positivos de caída.

---

# 2. Convergence in Advanced EIGRP

La convergencia ocurre cuando todos los routers tienen rutas coherentes. EIGRP logra convergencia rápida gracias a:

### • DUAL (Diffusing Update Algorithm)
- Procesa rutas pasivamente cuando existe un sucesor válido.
- Lanza estado Active solo cuando el sucesor deja de ser válido.

### • Successors y Feasible Successors
- El **Successor** es la mejor ruta.
- El **Feasible Successor (FS)** es una ruta de respaldo que cumple la *Feasibility Condition*:

```
Advertised Distance (AD) of neighbor < Feasible Distance (FD) of the current successor
```

Verificación:
```
show ip eigrp topology
```

---

# 3. Stuck in Active (SIA)

Una ruta entra en estado **Active** cuando el router no puede mantener la ruta pasiva y necesita preguntar a los vecinos si tienen un camino alterno.

Razones comunes:
- Congestión o pérdida de paquetes EIGRP.
- Enlaces lentos.
- Sobrecarga en CPU que evita procesar queries.
- Topologías no controladas (STUB incorrecto).

Síntomas:
```
%DUAL-3-SIA: Route 10.10.10.0/24 stuck in active
```

Mitigación:
- Implementar STUB routers.
- Implementar sumarización.
- Ajustar queries con "Query Boundaries".
- Revisar ACLs que bloqueen EIGRP.

Verificación:
```
debug eigrp neighbors
debug eigrp packets query
```

---

# 4. Route Summarization (Manual)

La sumarización reduce el número de prefijos que EIGRP anuncia.

Configuración en interface:
```
interface GigabitEthernet0/1
 ip summary-address eigrp 100 10.10.0.0 255.255.0.0
```

Verificación:
```
show ip eigrp topology
show ip protocols
```

---

# 5. Interface-Specific Summarization

EIGRP permite sumarizar diferente en cada interfaz. Esto permite:

- Crear “query boundaries”.
- Controlar SIA.
- Reducir el tamaño de la tabla de enrutamiento.

Ejemplo:
```
interface g0/0
 ip summary-address eigrp 100 10.1.0.0 255.255.0.0
```

---

# 6. Summary Discard Routes

Cuando se crea una sumarización, EIGRP instala automáticamente una ruta “discard” hacia Null0 para evitar loops.

Ejemplo de tabla:
```
D   10.0.0.0/8 is a summary, Null0
```

La métrica de la ruta de summary es:
- La menor métrica de entre las rutas individuales.

---

# 7. Summarization Metrics

EIGRP calcula la métrica del summary usando:
- El **menor FD** de los prefijos que agrupa.
- No hace promedio.

Comandos:
```
show ip eigrp topology | include FD
```

---

# 8. Automatic Summarization

Antes de IOS 15 estaba activada por defecto. Divide rutas por límites de clase.

Deshabilitar:
```
router eigrp 100
 no auto-summary
```

---

# 9. WAN Considerations

En entornos WAN existen riesgos:

### • Enlaces NBMA lentos → queries grandes → SIA
### • Multipoint interfaces → Split Horizon
### • DMVPN → next-hop-self, no-override, NHRP dependencies

Ajustes típicos:
```
router eigrp 100
 timers active-time 3
```

---

# 10. EIGRP Stub Router

Funciona para limitar queries en rutas de edge.

Configuración:
```
router eigrp 100
 eigrp stub connected summary
```

Opciones:
- connected
- static
- summary
- redisributed
- receive-only

Verificación:
```
show ip eigrp neighbors detail
```

Beneficios:
- Previene SIA.
- Controla flooding de queries.
- Reduce convergencia en sitios remotos.

---

# 11. Stub Site Functions

Un STUB:
- No procesa rutas externas.
- Solo anuncia rutas locales.
- Crea boundaries naturales para queries.

Muy recomendado para:
- Sucursales.
- DMVPN spoke routers.

---

# 12. IP Bandwidth Percentage

EIGRP por defecto usa máximo el **50% del ancho de banda** para tráfico EIGRP (hello, updates).

Modificar:
```
interface s0/0
 ip bandwidth-percent eigrp 100 30
```

Significa:
- “Permitir que EIGRP use 30% del BW configurado”.

Importante:
- Basado en bw configurado, NO en el real.

---

# 13. Split Horizon

Evita enviar de regreso una ruta aprendida por la misma interfaz.

Necesario deshabilitarlo en:
- Frame Relay multipoint.
- DMVPN.
- Hub-and-Spoke con single interface.

Disable:
```
interface Tunnel0
 no ip split-horizon eigrp 100
```

---

# 14. Route Manipulation (EIGRP)

EIGRP permite manipular rutas usando:

### • Offset Lists  
Incrementa la métrica de rutas aprendidas.

### • Distribute Lists  
Filtran prefijos EIGRP.

### • Route Tags  
Evita loops en redistribución.

---

# 15. Route Filtering

Métodos disponibles:

### 1. Distribute-lists (ACLs o prefix-lists)
Ejemplo:
```
router eigrp 100
 distribute-list prefix BLOCK_OUT out g0/0

ip prefix-list BLOCK_OUT deny 10.10.0.0/16
ip prefix-list BLOCK_OUT permit 0.0.0.0/0 le 32
```

### 2. Route maps
```
router eigrp 100
 distribute-list route-map FILTER in g0/1

route-map FILTER deny 10
 match ip address prefix-list BAD

route-map FILTER permit 20
```

---

# 16. Traffic Steering with EIGRP Offset Lists

Permite aumentar artificialmente la métrica para influir en la selección del Successor.

Ejemplo:
```
access-list 10 permit 10.10.10.0 0.0.0.255

router eigrp 100
 offset-list 10 in 5000 g0/1
```

Resultado:
- La ruta vía g0/1 tiene mayor métrica → no será Successor.
- Ruteo influenciado sin redistribución ni sumarización.

---

# 17. Troubleshooting Commands

Siempre dominar para ENARSI:

```
show ip eigrp topology
show ip eigrp neighbors
show ip eigrp traffic
debug eigrp fsm
debug eigrp packets query
show ip eigrp interfaces detail
show ip route eigrp
```

---

# 18. Mini-Lab ENARSI – Advanced EIGRP

Topología simple:

R1 — R2 — R3  

## Lab Tasks

### 1. Configurar EIGRP
```
router eigrp 100
 no auto-summary
 network 10.0.0.0 0.0.0.255
```

### 2. Sumarización en R1 hacia R2
```
interface g0/0
 ip summary-address eigrp 100 10.0.0.0 255.255.248.0
```

### 3. Crear R3 como STUB
```
router eigrp 100
 eigrp stub connected static summary
```

### 4. Manipular tráfico con offset list
```
access-list 5 permit 10.20.20.0 0.0.0.255
router eigrp 100
 offset-list 5 in 3000 g0/1
```

### 5. Verificar que no hayan estados Active o SIA
```
show ip eigrp topology active
```

---

# 19. Resumen para Memoria (Examen ENARSI)

- Stuck-in-Active = 90% de las veces por falta de FS + inundación de queries.
- EIGRP Stub = herramienta más poderosa de control de queries.
- Summaries = crean rutas Null0 automáticamente.
- Hold Timer ≠ necesita coincidir entre vecinos.
- Offset-lists = manipulación de métricas, no de prefijos.
- Split-horizon = siempre revisar en DMVPN.

---


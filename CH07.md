# Chapter 7 – Advanced OSPF  
## ENARSI Deep Technical Edition

---

# 1. Link-State Advertisements (LSAs)

Los LSAs son la base del funcionamiento de OSPF.  
Cada router genera LSAs describiendo el estado de sus enlaces, y todas las LSAs forman la **LSDB (Link-State Database)**.

Propiedades clave:
- Cada LSA tiene **type**, **ID**, **advertising router**, **age**, **sequence number**.
- Se inundan por toda el área (o dominio) según su tipo.
- Cada router calcula SPF basándose en la LSDB.

Ver LSDB:
```
show ip ospf database
```

---

# 2. LSA Sequences

Cada LSA contiene un número de secuencia (sequence number) que determina qué versión es más reciente.

Valores típicos:
```
0x80000001  → primero válido  
0x7FFFFFFF  → máximo permitido  
```

Si se llega al máximo → el router reinicia el LSA:

```
Flush LSA → Age 3600 → nuevo LSA
```

Ver versiones:
```
show ip ospf database router
```

---

# 3. LSA Age and Flooding

Cada LSA empieza con **age = 0** y aumenta por segundo.

- Máxima edad = **3600 s** (LSA Max Age).
- A los 1800 s el router refresca el LSA.
- A los 3600 s el LSA expira y se retira.

Flooding:
- Se envían LSUs (Link-State Updates) cuando cambia topología.
- Se requiere confirmación con LSAck.

Debug:
```
debug ip ospf flood
```

---

# 4. LSA Types (IPv4 OSPFv2)

Los tipos más usados en ENARSI:

| LSA | Nombre                        | Alcance              | Generado por |
|-----|-------------------------------|-----------------------|--------------|
| 1   | Router LSA                    | Área                 | Cada router |
| 2   | Network LSA                   | Área                 | DR |
| 3   | Summary LSA                   | Área a área          | ABR |
| 4   | ASBR Summary LSA              | Área a área          | ABR |
| 5   | External LSA                  | Dominio entero       | ASBR |
| 7   | NSSA External LSA             | NSSA area            | ASBR en NSSA |

---

# 5. LSA Type 1: Router Link

Describe todos los enlaces del router dentro de su área.

Incluye:
- Interfaces
- Costos
- Vecinos

Ver:
```
show ip ospf database router
```

---

# 6. LSA Type 2: Network Link

Generado por el **DR**.  
Describe todos los routers en un segmento broadcast.

Ver:
```
show ip ospf database network
```

---

# 7. LSA Type 3: Summary Link

Generado por un ABR para anunciar prefijos entre áreas.

Ejemplo:
- Área 1 → ABR → Área 0

Ver:
```
show ip ospf database summary
```

---

# 8. LSA Type 5: External Routes

Se generan al redistribuir rutas externas hacia OSPF.

Tipos:
- **E1** → Costo = externo + interno acumulado.
- **E2** → Costo = solo externo (por defecto).

Ver:
```
show ip ospf database external
```

---

# 9. LSA Type 4: ASBR Summary

Identifica la ruta hacia el ASBR para instalar rutas externas.

Generado por ABR.

Ver:
```
show ip ospf database asbr-summary
```

---

# 10. LSA Type 7: NSSA External Summary

En **NSSA**, las rutas externas se introducen como **LSA7**, no como LSA5.

El ABR convierte:
```
LSA7 → LSA5
```

Ver:
```
show ip ospf database nssa-external
```

---

# 11. LSA Type Summary

Recordatorio ENARSI:

- Tipo 1 y 2 → dentro del área.
- Tipo 3 y 4 → entre áreas.
- Tipo 5 → externas.
- Tipo 7 → externas en NSSA.

---

# 12. OSPF Stubby Areas (OSPF SA Options)

---

## 12.1 Stub Areas

Características:
- No permiten LSA Type 5.
- ABR introduce una **default route** como LSAs Tipo 3.
- Reducen LSDB.

Config:
```
router ospf 1
 area 1 stub
```

---

## 12.2 Totally Stubby Areas (TSA)

Cisco no estándar.  
Bloquea:
- Type 5 (externas)
- Type 3 (inter-areas)

Deja:
- Solo rutas internas del área
- Una default route del ABR

Config:
```
area 1 stub no-summary
```

---

## 12.3 Not-So-Stubby Areas (NSSA)

Permiten redistribución pero sin Type 5 → usan Type 7.

Config:
```
area 1 nssa
```

---

## 12.4 Totally NSSA

Bloquea LSAs Type 3 pero permite redistribución externa como Type 7.

Config:
```
area 1 nssa no-summary
```

---

# 13. OSPF Path Selection

OSPF usa la métrica basada en **cost**.

Por defecto:
```
Cost = 10^8 / bandwidth
```

Ver costo:
```
show ip ospf interface g0/0
```

---

## 13.1 Link Costs

Ajuste manual:
```
interface g0/0
 ip ospf cost 50
```

---

## 13.2 Intra-area Routes

Prioridad 1:
- Rutas dentro del área actual.
- LSAs 1 y 2.

Tabla:
```
O
```

---

## 13.3 Inter-area Routes

Prioridad 2:
- Prefijos aprendidos via ABR.
- LSA Type 3.

Tabla:
```
O IA
```

---

## 13.4 External Route Selection (E1 vs E2)

### E1 (Type 5/External Category 1)
Suma:
- Costo interno + costo externo

### E2 (por defecto)
Solo considera costo externo.

Prioridad:
1. Intra-area
2. Inter-area
3. E1
4. E2

Ver:
```
show ip route | include O
```

---

## 13.5 N1 y N2 (para NSSA)

Igual lógica que E1/E2 pero para Type 7.

---

# 14. Equal-Cost Multipathing (ECMP)

OSPF soporta rutas de igual costo.

Por defecto Cisco soporta hasta 4 rutas.

Cambiar:
```
router ospf 1
 maximum-paths 8
```

---

# 15. Summarization of Routes

---

## 15.1 Summarization Fundamentals

Resumen de rutas reduce LSDB y tráfico de flooding.

OSPF permite:
- Inter-area summarization (solo en ABR)
- External summarization (solo en ASBR)

---

# 15.2 Inter-area Summarization

Solo en ABRs:
```
router ospf 1
 area 1 range 10.10.0.0 255.255.0.0
```

Ver resumen:
```
show ip ospf database summary
```

---

# 15.3 External Summarization

Se realiza en ASBR:
```
router ospf 1
 summary-address 172.16.0.0 255.240.0.0
```

Ver:
```
show ip ospf database external
```

---

# 15.4 Discontiguous Network Problem

Si redes no contiguas se anuncian a través de múltiples áreas, pueden generarse rutas ambiguas.

Mitigación:
- Summaries correctos
- Diseño jerárquico sólido
- No abusar de redistribution

---

# 16. Virtual Links

Usados cuando un área no está conectado directamente al backbone.

Caso:
```
Area 1 — ABR — Area 0
Area 2 — ABR — Area 1 → necesita VL
```

Config:
```
router ospf 1
 area 1 virtual-link 2.2.2.2
```

Verificación:
```
show ip ospf virtual-links
```

---

# Resumen Final del Capítulo

- LSAs son el núcleo del funcionamiento OSPF.  
- Type 1/2 describen topología interna; Type 3/4 conectan áreas; 5 y 7 manejan externas.  
- Stub / Totally Stubby / NSSA / Totally NSSA optimizan LSDB y controlan LSAs externos.  
- OSPF selecciona rutas prioritizando intra > inter > externas.  
- Summaries en ABR (inter-area) y ASBR (externos).  
- Virtual links solo deben usarse como último recurso.  
- MTU, cost y DR/BDR siguen siendo factores críticos en troubleshooting.


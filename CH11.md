# **Capítulo 11 – BGP (Border Gateway Protocol)**

---

## **Introducción a BGP**

BGP (Border Gateway Protocol) es el **único protocolo de routing entre sistemas autónomos (inter-domain)** utilizado en Internet.  
Es un protocolo **path-vector**, altamente escalable, diseñado para tomar decisiones de enrutamiento basadas en **políticas**, no en métricas internas como OSPF o EIGRP.

Características clave:

- Funciona sobre **TCP puerto 179**.
    
- Mantiene sesiones estables llamadas **BGP Peers** o **Neighbors**.
    
- Utiliza **path attributes (PAs)** para determinar la mejor ruta.
    
- Es altamente controlable mediante políticas (route-maps, prefix-lists, filtros, attributes).
    
- Escala globalmente (decenas de miles de prefijos IPv4/IPv6).
    

---

# **1. Autonomous System Numbers (ASNs)**

Un **Sistema Autónomo (AS)** es un conjunto de redes bajo una misma administración con una política de enrutamiento común.

Los **ASNs** identifican de forma única a cada AS.

Tipos:

- **Públicos (1–64495)**: utilizados en Internet.
    
- **Privados (64512–65534)**: usados internamente.
    
- **ASNs de 32 bits**:  
    Formato: `X.Y` (por ejemplo 65000.300).
    

Ejemplo de asignación:

```
router bgp 65000
```

---

# **2. BGP Sessions**

BGP establece una conexión **TCP** entre dos routers para intercambiar rutas.

Tipos de peering:

- **eBGP (external BGP)**: entre AS diferentes.
    
- **iBGP (internal BGP)**: dentro del mismo AS.
    

Un peer se configura manualmente usando:

```
neighbor <IP> remote-as <ASN>
```

---

# **3. Path Attributes (PAs)**

Los atributos son los criterios que BGP usa para seleccionar la mejor ruta.

Atributos principales (orden simplificado):

1. **Weight (Cisco-only)** → mayor es mejor
    
2. **Local Preference** → mayor es mejor
    
3. **Locally originated routes**
    
4. **AS Path length** → más corto es mejor
    
5. **Origin type (IGP < EGP < Incomplete)**
    
6. **MED (Multi-Exit Discriminator)** → menor es mejor
    
7. **eBGP antes que iBGP**
    
8. **IGP metric hacia el next-hop**
    

Estos atributos permiten aplicar políticas de enrutamiento.

---

# **4. Loop Prevention**

BGP evita loops mediante el atributo:

**AS_PATH**:  
Cada AS que anuncia la ruta agrega su ASN al PATH.  
Si un router recibe una ruta que contiene su propio ASN → **descarta la ruta**.

Ejemplo:

```
AS_PATH: 65000 64512 65500
```

---

# **5. Address Families (AFI/SAFI)**

BGP es multiprotocolo. Soporta múltiples **Address Families**:

- IPv4 unicast
    
- IPv6 unicast
    
- VPNv4 / VPNv6
    
- Multicast
    
- EVPN (AFI=25, SAFI=70)
    

Se configuran bajo:

```
address-family ipv4 unicast
address-family ipv6 unicast
```

---

# **6. Inter-Router Communication**

BGP peers pueden usar:

- IPs de interfaces físicas
    
- Loopbacks (muy usado en iBGP)
    

Si se usa loopback, se debe configurar:

```
neighbor <IP> update-source Loopback0
```

e incrementar el TTL en eBGP hop-by-hop:

```
neighbor <IP> ebgp-multihop 2
```

---

# **7. BGP Messages**

BGP utiliza 4 tipos de mensajes, transportados por TCP:

1. **OPEN**: inicia la sesión.
    
2. **UPDATE**: envía rutas y retiros (withdraws).
    
3. **KEEPALIVE**: mantiene viva la conexión.
    
4. **NOTIFICATION**: reporta errores y termina la sesión.
    

---

# **8. BGP Neighbor States**

Los peers pasan por 6 estados:

1. **Idle**
    
2. **Connect**
    
3. **Active**
    
4. **OpenSent**
    
5. **OpenConfirm**
    
6. **Established** ← intercambio de rutas
    

Si no se llega a Established, hay problemas de:

- ACLs
    
- TCP/179 bloqueado
    
- IP incorrecta
    
- ASN erróneo
    
- Falta de reachability
    

---

# **9. Basic BGP Configuration**

Ejemplo mínimo:

```
router bgp 65000
 neighbor 10.1.1.2 remote-as 65001
```

Anunciar redes:

```
network 10.10.0.0 mask 255.255.0.0
```

Requiere que la red exista en la RIB.

---

# **10. Verification of BGP Sessions**

Comandos clave:

```
show bgp summary
show ip bgp
show ip bgp neighbors
show ip bgp <prefix>
```

---

# **11. Route Advertisement**

Una ruta **solo se anuncia si**:

- Fue aprendida por BGP **o**
    
- Existe en la RIB y coincide exactamente con el comando `network`.
    

Redistribución:

```
redistribute ospf 1
```

Advertencia: peligro de loops sin route-maps.

---

# **12. Receiving and Viewing Routes**

```
show ip bgp
show ip bgp neighbors <IP> received-routes
show ip bgp neighbors <IP> advertised-routes
```

---

# **13. Understanding BGP Session Types and Behaviors**

## **iBGP**

- Dentro del mismo AS.
    
- No modifica AS_PATH.
    
- Next-hop no cambia por defecto.
    

Reglas importantes:

### **iBGP Full Mesh Requirement**

Todos los iBGP routers deben tener peering entre sí, a menos que se implementen mecanismos de escalabilidad.

### **Peering Using Loopback Addresses**

Muy recomendado en iBGP:

```
neighbor <IP> update-source Loopback0
```

---

## **eBGP**

- Entre AS diferentes.
    
- TTL por defecto = 1.
    
- Next-hop cambia automáticamente en eBGP.
    

---

## **eBGP and iBGP Topologies**

Características:

- eBGP → rutas entran al AS.
    
- iBGP → distribuye rutas dentro del AS.
    
- iBGP no propaga rutas iBGP a otros iBGP peers (loop prevention).
    

---

# **14. Next-Hop Manipulation**

### Problema común:

Una ruta aprendida por eBGP se pasa a iBGP → _next-hop no cambia_.

Solución:

```
neighbor <IP> next-hop-self
```

---

# **15. iBGP Scalability Enhancements**

Para evitar iBGP Full Mesh:

- **Route Reflectors (RRs)**
    
- **Confederations**
    

---

# **16. Route Reflectors (RR)**

Un Route Reflector cumple dos funciones:

- Permite que iBGP peers no estén totalmente mallados.
    
- Reflecta rutas entre clientes.
    

Configuración básica RR:

```
router bgp 65000
 neighbor 10.1.1.2 route-reflector-client
```

---

# **17. Confederations**

Dividen un AS grande en **AS internos**, reduciendo mesh.

Ejemplo:

```
router bgp 65000
 bgp confederation identifier 65000
 bgp confederation peers 65010 65020
```

---

# **18. Multiprotocol BGP for IPv6**

BGP puede transportar rutas IPv6 mediante:

- IPv6 nativo
    
- IPv6 sobre IPv4 (túneles, next-hop IPv4)
    

Habilitación:

```
address-family ipv6 unicast
```

---

# **19. IPv6 BGP Configuration**

Ejemplo:

```
router bgp 65000
 address-family ipv6 unicast
  neighbor 2001:DB8:1::2 remote-as 65001
  neighbor 2001:DB8:1::2 activate
  network 2001:DB8:100::/64
```

---

# **20. IPv6 over IPv4**

Permite usar IPv4 para transportar sesiones BGP IPv6:

```
neighbor 10.1.1.2 remote-as 65001
neighbor 10.1.1.2 update-source Loopback0
address-family ipv6 unicast
 neighbor 10.1.1.2 activate
```

Esto crea una sesión IPv6 AFI/SAFI sobre TCP IPv4.

---

# **Resumen Final del Capítulo**

BGP es un protocolo orientado a políticas, robusto, escalable y crítico para redes empresariales e Internet.  
Para certificación ENARSI, debes dominar:

- Cómo se establecen sesiones iBGP/eBGP
    
- Cómo se selecciona la mejor ruta
    
- Next-hop-self
    
- Route reflectors y confederations
    
- Multiprotocol BGP
    
- Verificación y resolución de problemas
# **Capítulo 12 – Advanced BGP**

Guía Completa de Estudio (ENARSI-Level)

---

# **1. Route Summarization en BGP**

La **sumarización** permite anunciar un rango más grande de prefijos en lugar de múltiples rutas específicas.  
BGP no realiza sumarización automática (como OSPF/EIGRP), **solo manual**.

Objetivos:

- Reducir tamaño de la tabla BGP.
    
- Ocultar subredes internas.
    
- Crear límites de estabilidad en la red.
    

---

# **2. Aggregate Addresses**

El comando principal:

```
aggregate-address <summary> <mask>
```

Opciones:

- `as-set` → construye un AS_PATH que incluye todos los AS de los prefijos agregados.
    
- `summary-only` → anuncia solo el agregado, suprime prefijos específicos.
    

Ejemplo:

```
router bgp 65000
 aggregate-address 10.0.0.0 255.0.0.0 summary-only
```

---

# **3. The Atomic Aggregate Attribute**

Cuando se anuncia un agregado que **no incluye** todos los detalles de las rutas más específicas, BGP marca el anuncio con:

**Atomic Aggregate**

Significa:

- “Esta ruta ha sido resumida y puede perder información detallada.”
    
- Es un mecanismo para indicar pérdida de precisión.
    

---

# **4. Route Aggregation with AS_SET**

Cuando se usa:

```
aggregate-address x.x.x.x mask as-set
```

BGP:

- Incluye un **AS_SET** en el atributo AS_PATH.
    
- El AS_SET contiene todos los AS de los prefijos originales.
    
- Mantiene prevención de loops.
    

Ejemplo:

```
AS_PATH: {65010 65020 65030}
```

Llaves `{ }` indican AS_SET (orden no garantizado).

---

# **5. IPv6 Summarization**

La sumarización en IPv6 se basa en los mismos principios que IPv4:

```
address-family ipv6 unicast
 aggregate-address 2001:DB8:100::/48 summary-only
```

---

# **6. BGP Route Filtering and Manipulation**

BGP permite **filtrar y modificar rutas** con múltiples mecanismos:

- distribute-lists
    
- prefix-lists
    
- as-path access-lists
    
- route-maps
    
- communities
    

Estos se aplican inbound o outbound.

---

# **7. Distribute List Filtering**

Usa ACLs estandar/extendidas para filtrar rutas.

Ejemplo:

```
router bgp 65000
 neighbor 10.1.1.1 distribute-list 5 in
access-list 5 permit 10.0.0.0 0.255.255.255
```

Limitación: ACLs no son muy expresivas para prefijos.

---

# **8. Prefix List Filtering**

La forma moderna y recomendada de filtrar prefijos.

Ejemplo:

```
ip prefix-list PERMIT-10 permit 10.0.0.0/8 le 24
router bgp 65000
 neighbor 10.1.1.1 prefix-list PERMIT-10 in
```
Ventajas:

- Coincidencia precisa con `ge` y `le`
    
- Fácil de leer
    
- Rendimiento mejor que ACLs
    

---

# **9. AS_Path Filtering**

Para filtrar rutas basadas en el **AS_PATH**.

Se usa:

- Expresiones regulares (regex)
    
- AS-path access-lists
    

---

# **10. Regular Expressions (Regex)** en BGP

Cisco soporta regex avanzados para coincidencias en AS_PATH.

Ejemplos comunes:

- `^$` → rutas originadas localmente (AS_PATH vacío)
    
- `^65000$` → rutas originadas por AS 65000
    
- `^65000_` → rutas donde el primer AS es 65000
    
- `_65000$` → rutas cuyo último AS es 65000
    
- `_65000_` → AS 65000 aparece en cualquier lugar del AS_PATH
    
- `^$` → iBGP-originated
    

---

# **11. AS_Path ACLs**

Ejemplo:

```
ip as-path access-list 10 permit ^65000$
router bgp 65000
 neighbor 10.1.1.1 filter-list 10 in
```

Controla anuncios inbound/outbound basados en AS_PATH.

---

# **12. Route Maps**

Los route-maps permiten:

- Filtrar
    
- Modificar atributos
    
- Aplicar políticas avanzadas
    

Ejemplo:

```
route-map SETLP permit 10
 set local-preference 200

router bgp 65000
 neighbor 10.1.1.1 route-map SETLP in
```

Funciones típicas:

- Manipular local-preference
    
- Cambiar MED
    
- Ajustar weight
    
- Alterar next-hop
    
- Condicionales con match comunitarios
    

---

# **13. Clearing BGP Connections**

Se usa para aplicar cambios inmediatamente.

```
clear ip bgp <neighbor> soft in
clear ip bgp <neighbor> soft out
clear ip bgp <neighbor> hard   ← reinicia TCP (más agresivo)
```

Soft reconfiguration:

- No reinicia la sesión TCP
    
- Permite refresh del RIB externo e interno
    

---

# **14. BGP Communities**

Las comunidades son etiquetas usadas para aplicar políticas.

Se agregan con:

```
set community <value>
```

Debes habilitar su envío:

```
neighbor <IP> send-community
```

---

# **15. Enabling BGP Community Support**

Por defecto, los routers **no envían communities**.

Se debe configurar:

```
neighbor <IP> send-community
```

Opciones:

- `send-community` → estándar
    
- `send-community extended` → extended communities
    

---

# **16. Well-Known Communities**

Cisco reconoce varias comunidades especiales:

|Comunidad|Función|
|---|---|
|**no-export**|No anunciar fuera del AS|
|**no-advertise**|No anunciar a ningún peer|
|**local-AS / no-export-subconfed**|No anunciar fuera del subconfederation|
|**internet**|Anunciar a todos|

---

# **17. The No_Advertise Community**

La comunidad:

```
no-advertise
```

Indica:

- La ruta **no debe ser anunciada a ningún vecino BGP**.
    
- Sólo permanece local en el router.
    

---

# **18. The No_Export Community**

Indica:

- La ruta **no puede salir del AS**.
    
- Puede circular entre iBGP y eBGP dentro del mismo AS, pero **no hacia Internet**.
    

Ejemplo:

```
set community no-export
```

---

# **19. The Local AS (No_Export_SubConfed) Community**

Útil dentro de **confederaciones**.

`local-AS`:

- Permite distribuir rutas dentro del subconfederation.
    
- Impide anuncio fuera de él.
    

---

# **20. Conditionally Matching BGP Communities**

Se puede filtrar por comunidad:

```
ip community-list 10 permit 65000:100
route-map MATCHCOMM permit 10
 match community 10
```

Luego aplicarlo a un vecino.

---

# **21. Setting Private BGP Communities**

Comunidades personalizadas:

```
set community 65000:999 additive
```

`additive` preserva comunidades existentes.

---

# **22. Maximum Prefix**

Protege contra recibir demasiadas rutas:

```
neighbor 10.1.1.1 maximum-prefix 500 75 restart 5
```

Significa:

- Máximo 500 rutas
    
- Advertencia al 75%
    
- Restablecer sesión en 5 minutos
    

Previene fallos provocados por:

- Problemas de routing en el peer
    
- Publicaciones erróneas de rutas
    
- Ataques de inundación de prefijos
    

---

# **23. Configuration Scalability**

En redes grandes, gestionar múltiples vecinos es complejo.  
Cisco introduce:

- **Peer Groups (IOS tradicional)**
    
- **Peer Templates (IOS XE moderno)**
    

---

# **24. IOS XE Peer Groups**

Permiten agrupar vecinos con políticas comunes.

```
router bgp 65000
 bgp peer-group EBGP-PEERS
 neighbor 10.1.1.1 peer-group EBGP-PEERS
 neighbor 10.1.1.2 peer-group EBGP-PEERS
```

Se configuran políticas una sola vez.

---

# **25. IOS XE Peer Templates**

Templates modulares y reutilizables.

Tipos:

- **Session templates** → parámetros del BGP session
    
- **Policy templates** → políticas de rutas comunes
    

Ejemplo:

```
template peer-session EBGPSESSION
 remote-as 65001

template peer-policy EBGP-POLICY
 route-reflector-client

router bgp 65000
 neighbor 10.1.1.1 inherit peer-session EBGPSESSION
 neighbor 10.1.1.1 inherit peer-policy EBGP-POLICY
```

Ventajas:

- Simplificación del BGP
    
- Escalabilidad
    
- Reducción de errores
    

---

# **Resumen Final del Capítulo**

En este capítulo se profundizó en:

- Sumarización (IPv4/IPv6)
    
- Aggregate-address, atomic aggregate, AS_SET
    
- Filtrado avanzado: prefix-lists, regex, as-path, route-maps
    
- Communities (básicas y avanzadas)
    
- Maximum-prefix
    
- Peer groups / peer templates
    

Para el examen ENARSI debes poder:

- Escribir y leer prefix-lists con precisión
    
- Interpretar AS_PATH con regex
    
- Controlar anuncios con communities
    
- Configurar route-maps para manipulación avanzada
    
- Escalar BGP con peer groups y templates
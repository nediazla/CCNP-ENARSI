# **Capítulo 13 – BGP Path Selection (Selección de Ruta BGP)**

Guía Completa para Certificación (ENARSI)

---

# **1. Understanding BGP Path Selection**

Cuando un router BGP recibe **múltiples rutas** hacia el mismo prefijo, debe seleccionar **una sola** como “best path” para instalar en la RIB y anunciar a sus peers.

BGP utiliza un proceso secuencial **determinístico**, donde se compara atributo por atributo **en orden**, hasta encontrar un ganador.

El orden clásico es:

1. Weight
    
2. Local Preference
    
3. Locally originated
    
4. Shortest AS_PATH
    
5. Origin type
    
6. MED
    
7. eBGP over iBGP
    
8. IGP metric to next-hop
    
9. Prefer oldest eBGP session
    
10. Router ID
    
11. Cluster list length
    
12. Lowest neighbor address
    

Este orden puede alterarse con configuraciones específicas (como deterministic-med, always-compare-med, multipath).

---

# **2. BGP Best Path**

El “Best Path” es la ruta seleccionada por el algoritmo de comparación.  
Solo **una** ruta se anuncia a los peers, salvo que BGP multipath esté habilitado.

---

# **3. Weight (Cisco-only Attribute)**

- Atributo propietario de Cisco.
    
- **No se propaga** a otros routers.
    
- **Mayor es mejor**.
    
- Es el primer criterio evaluado.
    
- Permite forzar selección local.
    

Ejemplo:

```
set weight 500
```

---

# **4. Local Preference**

- Atributo **intra-AS**, propagado dentro del AS.
    
- Indica preferencia para **salir del AS** por un determinado camino.
    
- **Mayor es mejor**.
    

Se configura normalmente inbound en eBGP:

```
set local-preference 200
```

Ejemplo de flujo de preferencia global dentro del AS.

---

# **5. Phase I: Initial BGP Edge Route Processing**

Antes de comparar rutas, BGP:

1. Valida el next-hop.
    
2. Descarta rutas no alcanzables.
    
3. Normaliza atributos.
    

Rutas sin next-hop alcanzable **no participan** en el proceso.

---

# **6. Phase II: BGP Edge Evaluation of Multiple Paths**

El router comienza a evaluar las rutas aplicando el orden estándar:

### **1) Weight**

Rutas con mayor weight ganan.

### **2) Local Preference**

Mayor local pref = mejor salida del AS.

### **3) Locally Originated**

Rutas originadas localmente por:

- `network`
    
- `redistribute`
    
- `aggregate-address`
    
- `next-hop-self`
    

tienen preferencia.

---

# **7. Phase III: Final BGP Processing State**

Si aún hay empate, se continúa con:

- AS_PATH
    
- Origin
    
- MED
    
- eBGP vs iBGP
    
- IGP metric
    
- Router ID
    
- Cluster list
    
- Neighbor address
    

Hasta resolver la ruta final.

---

# **8. Locally Originated in the Network or Aggregate Advertisement**

Rutas generadas localmente se consideran preferibles porque:

- No tienen AS_PATH
    
- Son agregados creados por un administrador
    
- Indican preferencia explícita
    

Ejemplo:

```
network 172.16.0.0 mask 255.255.0.0
```

---

# **9. Accumulated Interior Gateway Protocol (AIGP)**

AIGP es un atributo para redes grandes donde se requiere influir path selection con información **acumulada de IGP**.

Diseñado para escenarios multi-AS dentro de proveedores.

Define un “cost” acumulado basado en OSPF/ISIS/IGP interno.

---

# **10. Shortest AS_Path**

Regla clásica de BGP.

- **Menor número de AS hops** es preferido.
    
- Buena forma de evitar rutas largas hacia destinos remotos.
    
- Se aplica mediante inspección del atributo AS_PATH.
    

No confundir: AS_SET (de sumarización) no cuenta igual que AS_SEQUENCE.

---

# **11. Origin Type**

Los tipos, en orden de preferencia:

1. **IGP (i)** → mejor
    
2. **EGP (e)**
    
3. **Incomplete (?)** → peor
    

Ejemplo de salida:

```
i → route originated via network
? → redistributed route
```

---

# **12. Multi-Exit Discriminator (MED)**

- Indica preferencia **entre múltiples enlaces ENTRANTES** desde un AS vecino.
    
- **Menor es mejor**.
    
- Solo se compara entre rutas del **mismo AS vecino**, a menos que se altere comportamiento.
    

Ejemplo:

```
set metric 50
```

---

# **13. Missing MED Behavior**

Si un peer no envía MED:

- En IOS clásico: MED faltante = MED 0 (mejor).
    
- En IOS moderno (IOS-XE): puede comportarse como “missing means worst” según RFC.
    

Esto puede cambiar con:

```
bgp bestpath med missing-as-worst
```

---

# **14. Always Compare MED**

Por defecto, MED solo se compara entre rutas que vienen del **mismo AS origen**.

Para comparar MED entre diferentes AS:

```
bgp always-compare-med
```

Esto puede cambiar el resultado de manera global y debe usarse con cuidado.

---

# **15. BGP Deterministic MED**

Problema:  
Al recibir rutas en diferente orden, BGP puede seleccionar rutas inconsistentes.

Solución:

```
bgp deterministic-med
```

Hace que BGP agrupe rutas por AS y compare dentro del mismo AS de manera determinista.

---

# **16. eBGP over iBGP**

Si aún hay empate:

**eBGP > iBGP**

Porque eBGP es considerado más “directo” hacia el origen.

Esto también evita loops y rutas de demasiados saltos internos.

---

# **17. Lowest IGP Metric to Next-Hop**

Si todas las rutas siguen empatadas:

El router elegirá la que tenga **menor costo IGP** (OSPF/EIGRP/ISIS) hacia el next-hop.

Ejemplo:

```
show ip route <next-hop>
```

---

# **18. Prefer the Oldest eBGP Session**

IOS prefiere mantener estable la ruta eBGP más antigua.

Esto evita "route flapping" si múltiples rutas son iguales.

Se puede desactivar:

```
bgp bestpath compare-routerid
```

(afecta otras fases también)

---

# **19. Router ID**

Si continúa el empate:

**Menor router-ID gana**.

Router-ID puede ser:

- Loopback más alta
    
- Dirección activa más alta
    
- Configurada manualmente
    

---

# **20. Minimum Cluster List Length**

Esto solo se aplica si participan **Route Reflectors**.

- BGP prefiere la ruta cuyo **CLUSTER_LIST** sea más corto.
    

CLUSTER_LIST ayuda a prevenir loops en topologías con RR.

---

# **21. Lowest Neighbor Address**

Último criterio:  
Si todas las rutas son idénticas:

**La IP del vecino más baja gana.**

---

# **22. BGP Multipath**

Permite instalar **múltiples rutas BGP** cuando las rutas son equivalentes.

Habilitación:

```
maximum-paths 2
```

Para iBGP multipath:

```
maximum-paths ibgp 4
```

Requisitos:

- Next-hop debe ser diferente
    
- Los atributos relevantes deben coincidir
    
- Local pref, AS_PATH, MED, origin y demás deben ser iguales
    

---

# **Resumen Final del Capítulo**

Este capítulo analiza el **corazón del funcionamiento de BGP**:  
El **algoritmo de selección de mejor ruta**.

Debes recordar:

- El orden exacto de selección
    
- Qué atributos son locales, cuáles se propagan
    
- Cómo MED se compara (same-AS vs always-compare-med)
    
- Cómo funcionan weight y local-pref
    
- Preferencias adicionales como oldest-session, router-ID, cluster-list
    
- Habilitar multipath para balanceo
    

Dominar esto es fundamental para aprobar ENARSI y para operar redes BGP de nivel empresarial.
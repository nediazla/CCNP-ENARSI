# **Capítulo 14 – Troubleshooting BGP**

Guía Completa de Diagnóstico para ENARSI

---

BGP es extremadamente robusto, pero también muy estricto:  
si **cualquier parámetro** falla, la sesión cae o las rutas no se propagan.  
Este capítulo aborda los problemas más comunes y la metodología de resolución.

---

# **1. Troubleshooting BGP Neighbor Adjacencies**

Cuando una sesión BGP no alcanza el estado **Established**, siempre existe un problema en uno de estos niveles:

1. Capa 1 / Capa 2
    
2. Capa 3 / conectividad IP
    
3. Configuración incorrecta
    
4. Filtros / políticas
    
5. Seguridad (TTL, autenticación, ACL)
    

Verificación inicial:

```
show bgp summary
```

Estados típicos problemáticos: Idle, Active, OpenSent, OpenConfirm.

---

## **1.1 Interface Is Down**

Si la interfaz que origina la sesión está caída:

- No hay TCP
    
- No hay BGP
    
- No hay ARP
    
- No hay Next-Hop reachability
    

Verificación:

```
show ip interface brief
show interface <name>
```

La sesión quedará en **Idle**.

---

## **1.2 Layer 3 Connectivity Is Broken**

Aunque la interfaz esté up, puede faltar reachability IP.

Causas comunes:

- Ruta incorrecta o ausente
    
- Next-hop equivocado
    
- ARP fallido
    
- Problemas de VPN / túneles
    

Comando clave:

```
ping <peer-ip>
traceroute <peer-ip>
```

---

## **1.3 Path to the Neighbor Is Through the Default Route**

BGP **requiere** una ruta específica hacia el peer BGP.

Si el tráfico hacia el peer sale por una **default route**, pero esa ruta no devuelve tráfico, la sesión no se forma.

La sesión queda en Active.

Solución:

- Añadir ruta específica hacia la IP del peer.
    

---

## **1.4 Neighbor Does Not Have a Route to the Local Router**

La conectividad debe ser **bidireccional**.

Si solo uno de los routers tiene la ruta:

- SYN llega
    
- SYN-ACK no llega
    
- TCP falla → BGP fallará
    

Solución:

- Asegurar ruta estática o IGP hacia el peer.
    

---

## **1.5 Incorrect neighbor Statement**

Uno de los motivos más comunes.

Ejemplos:

- ASN incorrecto
    
- IP equivocada
    
- Comando bajo router BGP incorrecto
    

Ejemplo:

```
%TCP-6-OPEN: Connection to 10.1.1.2 port 179 refused by peer
```

Indica ASN incorrecto en el peer.

---

## **1.6 BGP Packets Sourced from the Wrong IP Address**

Especialmente frecuente cuando se usa **loopback** para iBGP.

Solución:

```
neighbor <IP> update-source Loopback0
```

Si el peer espera una IP y la sesión llega desde otra, no se establecerá.

---

## **1.7 ACLs**

Filtros en:

- Interfaces
    
- Firewalls
    
- Control-Plane Policing (CoPP)
    
- Port filters sobre TCP/179
    

Verificación:

```
show access-lists
show ip interface <int>
```

Importante: permitir **TCP 179** de ida y vuelta.

---

## **1.8 The TTL of the BGP Packet Expires**

Por defecto:

- eBGP usa **TTL=1**
    
- iBGP usa TTL normal (255)
    

Si se usa loopback o un salto intermedio:

BGP fallará salvo que se configure:

```
neighbor <IP> ebgp-multihop 2
neighbor <IP> ttl-security hops <n>
```

---

## **1.9 Mismatched Authentication**

Si se usa autenticación MD5:

```
neighbor <IP> password <value>
```

Si la clave no coincide:

- La sesión queda en Active o Idle
    
- Mensaje en logs: “MD5 digest mismatch”
    

Verificación:

```
debug ip tcp transactions
debug ip bgp
```

---

## **1.10 Misconfigured Peer Groups**

Peer-groups requieren parámetros coherentes.

Problemas típicos:

- Peer-group asignado a vecinos incorrectos
    
- Políticas heredadas no compatibles
    
- Configuración parcial
    

Comando útil:

```
show running-config | section bgp
```

---

## **1.11 Timers**

Los timers BGP deben coincidir para evitar resets de sesión.

Parámetros clave:

- Keepalive (default 60s)
    
- Hold time (default 180s)
    

Si un peer reduce su hold time por debajo del mínimo permitido por el otro, la sesión se cae.

Verificación:

```
show ip bgp neighbors | include hold
```

---

# **2. Troubleshooting BGP Routes**

Sesión establecida pero **no se ven rutas**:

Problema distinto al de adyacencias.

---

## **2.1 Missing or Bad network mask Command**

El comando `network` solo anuncia prefijos que **existen en la RIB**.

Ejemplo problemático:

```
network 10.1.0.0 mask 255.255.0.0
```

Si la ruta en la RIB es /24, NO se anuncia.

---

## **2.2 Next-Hop Router Not Reachable**

En iBGP:

- El next-hop **no se modifica**.
    

Si un router no tiene ruta al next-hop → no instala la ruta.

Solución:

```
neighbor <IP> next-hop-self
```

---

## **2.3 BGP Split-Horizon Rule**

iBGP **no propaga rutas** aprendidas por otro iBGP.

Solución:

- Route Reflectors
    
- Confederaciones
    
- Reducción de mallas complejas
    

---

## **2.4 Better Source of Information**

Si otra fuente tiene mejores atributos:

- Local-pref más alto
    
- Weight mayor
    
- Mejor AS_PATH
    
- Preferencia de IGP hacia next-hop
    

La ruta BGP NO se instalará.

Verificación:

```
show ip bgp <prefix> verbose
```

---

## **2.5 Route Filtering**

Filtros inbound pueden **bloquear rutas**:

- Prefix lists
    
- Route maps
    
- AS-path filters
    
- Communities
    
- Maximum-prefix
    

Analizar:

```
show ip bgp neighbors <IP> received-routes
show ip bgp neighbors <IP> routes
```

---

# **3. Troubleshooting BGP Path Selection**

Aquí se analiza por qué **no se elige** la ruta esperada.

Se debe revisar el proceso de best-path:

1. Weight
    
2. Local-pref
    
3. Locally originated
    
4. AS-PATH
    
5. Origin
    
6. MED
    
7. eBGP/iBGP
    
8. IGP metric
    
9. Oldest eBGP
    
10. Router-ID
    

Comando esencial:

```
show ip bgp <prefix>
```

---

# **4. Private Autonomous System Numbers**

Si un peer anuncia rutas con **ASN privados**, estas deben ser eliminadas al salir a Internet:

```
neighbor <IP> remove-private-as
```

Problemas típicos:

- Rutas rechazadas por el ISP
    
- Loops administrativos no deseados
    

---

# **5. Using debug Commands**

Comandos peligrosos en producción.

Para diagnóstico profundo:

```
debug ip bgp
debug ip bgp events
debug ip bgp updates
debug ip tcp transactions
```

Siempre usar con:

```
terminal monitor
```

Y desactivar:

```
undebug all
```

---

# **6. Troubleshooting BGP for IPv6**

Diferencias clave:

- IPv6 requiere **address-family ipv6 unicast**
    
- Next-hop IPv6 debe ser alcanzable
    
- Se debe activar el neighbor bajo el AFI:
    

```
address-family ipv6 unicast
 neighbor <IP> activate
```

Comandos:

```
show bgp ipv6 unicast
show bgp ipv6 unicast summary
```

---

# **7. BGP Trouble Tickets**

Aquí se presentan escenarios típicos de examen.

---

## **Trouble Ticket 14-1 – Neighbor Stuck in Active**

Causas probables:

- Ruta faltante hacia peer
    
- ACL bloqueando TCP/179
    
- ASN incorrecto
    
- TTL insuficiente
    

Solución:

- Verificar conectividad IP
    
- Revisar `neighbor remote-as`
    
- Habilitar `ebgp-multihop` si corresponde
    

---

## **Trouble Ticket 14-2 – Routes Not Appearing in BGP Table**

Causas:

- `network` incorrecto
    
- Prefijo no está en RIB
    
- Route filtering inbound
    
- Next-hop no alcanzable
    
- Split-horizon iBGP
    

Solución:

- Revisar `show ip route`
    
- Aplicar `next-hop-self`
    
- Revisar prefix-lists
    

---

## **Trouble Ticket 14-3 – Path Selection Unexpected**

Causas:

- Local-pref más alto en otra ruta
    
- Weight configurado manualmente
    
- MED inconsistente
    
- Always-compare-med habilitado
    
- Métrica IGP menor hacia otro next-hop
    

Solución:

- Inspeccionar atributos con `show ip bgp`
    

---

## **MP-BGP Trouble Ticket – IPv6 Not Propagating**

Causas:

- Neighbor no activado en AFI IPv6
    
- IPv6 next-hop no alcanzable
    
- Rutas faltantes o filtradas
    
- Falta `send-community` en extended attributes
    

Solución:

- Revisar address-family ipv6
    
- Verificar next-hop IPv6
    
- Revisar route-maps
    

---

## **Trouble Ticket 14-4 – Session Resets Repeatedly**

Causas:

- Mismatch de timers
    
- Autenticación MD5 incorrecta
    
- Peer-groups inconsistentes
    
- Maximum-prefix excedido
    
- Policies cambian atributos críticos
    

Solución:

- Revisar logs en `show log`
    
- Verificar timers y claves
    
- Revisar maximum-prefix
    

---

# **Resumen Final del Capítulo**

Este capítulo abordó las causas más frecuentes de fallos en BGP:

- Problemas de adyacencia (interfaz, IP, ASN, ACL, TTL, autenticación)
    
- Problemas de rutas (network incorrecto, next-hop, filtrado, split-horizon)
    
- Problemas de selección de ruta (atributos, configuraciones no visibles)
    
- Uso correcto de comandos `show` y `debug`
    
- Resolución de casos reales (trouble tickets)
    

Dominar este capítulo te permite resolver el 90% de los problemas de BGP en entornos reales y en examen ENARSI.
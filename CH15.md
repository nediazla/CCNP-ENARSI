# **Capítulo 15 – Route Maps and Conditional Forwarding**

---

Este capítulo profundiza en la manipulación avanzada de tráfico mediante **ACLs**, **prefix-lists**, **route-maps**, y **Policy-Based Routing (PBR)**.  
Aquí aprenderás a crear condiciones, aplicar acciones y reenviar tráfico según políticas definidas manualmente.

---

# **1. Conditional Matching**

El concepto clave en route-maps es el **matching condicional**:

Un route-map evalúa condiciones específicas:

- Prefijos
    
- Protocolos
    
- Interfaces
    
- Direcciones origen/destino
    
- Next-hop
    
- Longitud de prefijo
    
- Marcas de servicio (QoS)
    
- Comunidades BGP
    
- Otras etiquetas
    

Si un **match** coincide, se ejecuta un **set**.

Un route-map sin instrucciones `match` significa “coincide todo”.

---

# **2. Access Control Lists (ACLs)**

Usadas para definir condiciones que se pueden aplicar en route-maps o policy-based routing.

---

## **2.1 Standard ACLs**

Coinciden solo por:

- Dirección IP **origen**
    

Ejemplo:

```
access-list 10 permit 192.168.1.0 0.0.0.255
```

Limitadas para decisiones basadas exclusivamente en origen.

---

## **2.2 Extended ACLs**

Coinciden por:

- Origen
    
- Destino
    
- Protocolo
    
- Puerto
    

Ejemplo:

```
access-list 101 permit tcp 192.168.10.0 0.0.0.255 any eq 80
```

Necesarias para filtrados más específicos.

---

# **3. Prefix Matching**

Prefijos se coinciden mejor con:

- Prefix-lists IPv4
    
- Prefix-lists IPv6
    
- O combinándolos con route-maps para políticas dinámicas
    

---

## **3.1 Prefix Lists**

Más expresivas y eficientes que ACLs.

Ejemplo:

```
ip prefix-list LOCAL-NETS permit 10.0.0.0/8 le 24
```

Operadores:

- **ge X:** prefijos con longitud >= X
    
- **le X:** prefijos con longitud <= X
    

---

## **3.2 IPv6 Prefix Lists**

Analogía directa en IPv6:

```
ipv6 prefix-list IPV6-LAN permit 2001:DB8:100::/48 le /64
```

---

# **4. Route Maps**

Los route-maps son herramientas polivalentes utilizadas en:

- BGP
    
- Redistribución
    
- PBR
    
- QoS
    
- Manipulación de atributos
    

Su sintaxis se organiza en **secuencias numeradas**:

```
route-map NAME permit 10
 match <conditions>
 set <actions>
```

Si un `match` falla → pasa a la siguiente secuencia.

Si no hay más secuencias → deny implícito.

---

# **5. Conditional Matching (Route-Map Deep Dive)**

Los route-maps pueden usar múltiples matches:

```
match ip address 10
match interface GigabitEthernet0/1
match ip next-hop 192.168.1.1
```

Notas:

- Match dentro de la misma línea → lógico **OR**
    
- Match en líneas distintas → lógico **AND**
    

Ejemplo:

```
match ip address 10
match ip address 20
```

→ tráfico debe coincidir con ACL 10 **y** con ACL 20.

---

# **6. Complex Matching**

Puedes combinar ACLs, prefix-lists y otras condiciones:

```
route-map COMPLEX permit 10
 match ip address 101
 match ip address prefix-list SPECIAL
 match interface GigabitEthernet0/1
 set ip next-hop 10.1.1.1
```

Permite crear políticas extremadamente específicas.

---

# **7. Optional Actions (set Commands)**

Atributos configurables dentro de un route-map:

- Cambiar next-hop
    
- Marcar DSCP
    
- Cambiar direcciones origen/destino
    
- Cambiar costos IGP
    
- Ajustar atributos BGP
    
- Aplicar recirculación interna (local policy)
    

Ejemplo:

```
set ip next-hop 192.168.100.1
set interface GigabitEthernet0/2
set local-preference 200
```

---

# **8. Continue — Ejecutar Secuencias Adicionales**

El comando:

```
route-map <name> permit 10
 continue 20
```

Permite que un paquete continúe evaluando otras secuencias incluso después de un match exitoso.

Se usa para aplicar múltiples acciones o condiciones más complejas.

---

# **9. Conditional Forwarding of Packets**

Esto se conoce como **PBR (Policy-Based Routing)**.

El enrutamiento tradicional mira únicamente:

- Destino (IPv4/IPv6 routing)
    

Pero PBR permite reenviar tráfico basándose en:

- Dirección origen
    
- Aplicación
    
- Protocolo
    
- Marcado DSCP
    
- Interface de entrada
    
- Prefijo o listas especiales
    

PBR _no reemplaza_ el routing dinámico, sino que lo complementa a nivel de entrada.

---

# **10. PBR Configuration**

Pasos:

### 1. Crear ACL/prefix-list para identificar tráfico

```
access-list 101 permit tcp any any eq 443
```

### 2. Crear route-map

```
route-map PBR-HTTPS permit 10
 match ip address 101
 set ip next-hop 10.1.1.100
```

### 3. Aplicar en interfaz **de entrada**

```
interface GigabitEthernet0/0
 ip policy route-map PBR-HTTPS
```

Nota importante:  
Si un paquete no coincide → se usa la tabla de routing normal.

---

# **11. Local PBR**

Permite aplicar PBR incluso al **tráfico generado por el propio router**.

No se aplica en interfaces; se usa:

```
ip local policy route-map LOCAL-PBR
```

Escenario común:  
Forzar el router a usar un túnel/IPSec/vpn como salida preferente para servicios como DNS o syslog.

---

# **12. Trouble Tickets**

---

## **Trouble Ticket 15-1 – PBR No Está Siendo Aplicado**

Síntomas:

- El tráfico no sigue el next-hop configurado.
    
- En `show route-map`, el contador no aumenta.
    

Causas posibles:

- Route-map no aplicado en la interfaz correcta.
    
- ACL no coincide con el tráfico real.
    
- Tráfico cifrado o encapsulado (no visible para ACL).
    
- El next-hop no es alcanzable.
    

Validación:

```
show route-map
show ip policy
```

---

## **Trouble Ticket 15-2 – PBR Rompe Sesiones TCP**

Problema típico:

- Paquete forward inicial va por un camino → respuesta vuelve por otro.
    
- Esto crea **asincronía** y corta sesiones.
    

Causas:

- Next-hop incorrecto
    
- Política aplicada demasiado amplia
    
- Falta de rutas de retorno
    

Soluciones:

- Aplicar PBR solo a tráfico específico
    
- Asegurar rutas de retorno simétricas
    
- Usar VRF o tuneles para controlar caminos
    

---

## **Trouble Ticket 15-3 – Local PBR No Afecta Tráfico del Router**

Situación:

- Router usa default route aunque existe local policy.
    

Causas:

- Route-map sin `set` válido
    
- ACL no coincide
    
- Error común: política aplicada en interfaz en vez de local policy
    

Revisión:

```
show ip local policy
show route-map
```

---

# **Resumen Final del Capítulo**

En este capítulo aprendiste:

- Cómo funcionan los matches condicionales
    
- Standard y extended ACLs como filtros de entrada
    
- Uso de prefix-lists y IPv6 prefix-lists para coincidencias precisas
    
- Funcionamiento completo de route-maps
    
- Aplicación de políticas con PBR (global y local)
    
- Casos reales de troubleshooting
    

Dominar estos elementos te permite manipular tráfico con precisión quirúrgica, habilidad fundamental en routing avanzado y en el examen ENARSI.

# **Capítulo 18 – VRF, MPLS y MPLS Layer 3 VPNs**

---

Este capítulo integra tres pilares del routing avanzado:

1. **VRF-Lite** – Segmentación de routing en equipos sin MPLS.
    
2. **MPLS** – Mecanismo de etiquetado y conmutación para forwarding eficiente.
    
3. **MPLS Layer 3 VPNs** – Servicios VPN empresariales sobre infraestructura de proveedor.
    

Es uno de los bloques más importantes del examen ENARSI, y se fundamenta en conceptos comprobables y usados en producción.

---

# **1. Implementing and Verifying VRF-Lite**

VRF-Lite permite crear múltiples instancias de routing dentro de un mismo router **sin usar MPLS**.

Se usa para:

- Segmentación de clientes
    
- Separar tráfico de departamentos internos
    
- Multi-tenancy
    
- Simulación local de entornos MPLS
    

VRF-Lite = Virtual Routing and Forwarding _sin etiquetas MPLS_.

---

# **2. VRF-Lite Overview**

VRF-Lite permite que un router mantenga **tablas de routing independientes**, aislando:

- Rutas
    
- ARP
    
- Interfaces
    
- Políticas
    
- Vecinos BGP/OSPF/EIGRP
    

Cada VRF es como tener un “router lógico” dentro del mismo equipo.

---

# **3. Creating and Verifying VRF Instances**

Crear un VRF:

```
ip vrf CUSTOMER1
 rd 100:1
 route-target export 100:1
 route-target import 100:1
```

Asociar interfaces a un VRF:

```
interface GigabitEthernet0/0
 ip vrf forwarding CUSTOMER1
 ip address 10.1.1.1 255.255.255.0
```

Verificación:

```
show ip vrf
show ip route vrf CUSTOMER1
```

---

# **4. An Introduction to MPLS Operations**

MPLS (Multiprotocol Label Switching) agrega **etiquetas** a paquetes para mejorar el forwarding y habilitar servicios avanzados como VPNs, Traffic Engineering y QoS.

MPLS se basa en:

- LSR (Label Switching Routers)
    
- LIB y LFIB
    
- LSP (Label-Switched Path)
    
- LDP o RSVP-TE para distribuir etiquetas
    

Se usa en proveedores y grandes redes empresariales.

---

# **5. MPLS LIB and LFIB**

Dos tablas principales:

### **LIB – Label Information Base**

- Tabla de etiquetas **recibidas/advertidas** por LDP.
    
- Piensa en la LIB como la “tabla de control” de etiquetas.
    

Comando:

```
show mpls ldp bindings
```

### **LFIB – Label Forwarding Information Base**

- Tabla de **conmutación de etiquetas**.
    
- Lo que realmente usa el router en el data plane.
    

Comando:

```
show mpls forwarding-table
```

---

# **6. Label Switching Routers (LSRs)**

Tres roles en MPLS:

|Tipo de Router|Función|
|---|---|
|**Ingress LSR**|Inserta etiquetas (push)|
|**Transit LSR**|Cambia etiquetas (swap)|
|**Egress LSR**|Remueve etiquetas (pop)|

---

# **7. Forwarding Equivalence Class (FEC)**

Una **FEC** es un grupo de paquetes que reciben el mismo tratamiento en MPLS.

Ejemplos:

- Destino común (prefijo)
    
- Cliente específico en una VPN
    
- Clase de tráfico para TE/QoS
    

Cada FEC obtiene una etiqueta única dentro del dominio MPLS.

---

# **8. Label-Switched Path (LSP)**

Un LSP es un camino unidireccional preestablecido a través de la red MPLS.

Características:

- Se forma usando **LDP** o **RSVP-TE**
    
- Es unidireccional → bidireccional requiere dos LSPs
    
- No es un túnel clásico, aunque se comporta como uno a nivel forwarding
    

---

# **9. Labels**

Las etiquetas MPLS tienen 20 bits + campo EXP/TC + S bit + TTL.

Formato:

```
| Label (20) | TC (3) | S (1) | TTL (8) |
```

Operaciones:

- **Push**: agregar etiqueta
    
- **Swap**: cambiar etiqueta
    
- **Pop**: remover etiqueta
    

---

# **10. Label Distribution Protocol (LDP)**

Protocolo estándar para asignar etiquetas a prefijos.

Características:

- Basado en TCP/UDP 646
    
- Descubre vecinos a través de hellos multicasta
    
- Anuncia bindings etiqueta ↔ prefijo
    

Habilitación:

```
mpls ip
mpls ldp router-id Loopback0 force
```

Verificación:

```
show mpls ldp neighbor
```

---

# **11. Label Switching**

El forwarding MPLS se basa en:

- No mirar cabecera IP
    
- Forwarding basado en la etiqueta
    
- Búsqueda en LFIB → next-hop
    

Ventaja:

- Forwarding más rápido
    
- Flexibilidad para VPNs y TE
    

---

# **12. Penultimate-Hop Popping (PHP)**

PHP = El penúltimo router **elimina la etiqueta** para reducir la carga en el egress router.

Esto es normal:

```
LSR1 → LSR2 → LSR3 (egress)
```

LSR2 hace POP → LSR3 recibe IP pura.

Comando que muestra POP:

```
show mpls forwarding-table
```

---

# **13. MPLS LDP Features**

Funciones adicionales:

- LDP IGP Sync
    
- Explicit Null Label
    
- Targeted LDP
    
- LDP-IGP holddown
    

Ejemplo de explicit-null:

```
mpls ldp explicit-null
```

---

# **14. MPLS Traffic Engineering (TE)**

MPLS-TE usa **RSVP-TE** en lugar de LDP.

Permite:

- Reservar ancho de banda
    
- Evitar congestión
    
- Crear LSPs basados en constraints
    
- Ingeniería avanzada de tráfico
    

Configuración típica:

```
mpls traffic-eng tunnels
interface Tunnel10
 ip unnumbered Loopback0
 tunnel mode mpls traffic-eng
 tunnel mpls traffic-eng path-option 10 dynamic
```

---

# **15. An Introduction to MPLS Layer 3 VPNs**

MPLS L3 VPNs permiten a un proveedor ofrecer **VPNs enrutadas** a múltiples clientes usando etiquetas.

Componentes principales:

- **CE (Customer Edge)**
    
- **PE (Provider Edge)**
    
- **P (Provider)**
    
- VRFs
    
- RDs (Route Distinguisher)
    
- RTs (Route Targets)
    
- MP-BGP (BGP multiprotocolo)
    

---

# **16. MPLS Layer 3 VPNs**

Cada cliente obtiene:

- Un VRF
    
- Un RD
    
- Uno o más RTs
    
- BGP PE-PE para transportar rutas del cliente
    

El tráfico del cliente está **completamente separado**.

Rutas se transportan mediante **VPNv4** o **VPNv6**:

```
afi 1 / safi 128 → VPNv4
afi 2 / safi 128 → VPNv6
```

---

# **17. MPLS Layer 3 VPNv4 Addresses, RDs, and RTs**

## **Route Distinguisher (RD)**

- Hace únicas las rutas del cliente.
    
- No controla import/export.
    
- Formato: `ASN:nn` o `IP:nn`.
    

Ejemplo:

```
rd 65000:100
```

## **Route Targets (RTs)**

Controlan **qué rutas importa/exporta** cada VRF.

Ejemplo:

```
route-target import 65000:100
route-target export 65000:100
```

## **VPNv4 Address**

La dirección anunciada en MP-BGP incluye:

- RD
    
- IPv4 prefix
    
- Labels
    

Ejemplo:

```
65000:100:10.1.1.0/24
```

---

# **18. MPLS Layer 3 VPN Label Stack**

En MPLS L3 VPNs, se utilizan **dos etiquetas**:

### **1. Outer Label (Transport Label)**

- Proporcionada por LDP
    
- Permite viajar PE → P → PE
    
- POP normalmente mediante PHP
    

### **2. Inner Label (VPN Label)**

- Señala la VRF correcta en el PE destino
    
- Generada por MP-BGP
    

Formato del stack:

```
[Transport Label]
[VPN Label]
[IP Packet del Cliente]
```

En el PE de salida:

- Se hace POP de la outer label
    
- Se usa la VPN label para seleccionar VRF
    
- Se reenvía tráfico al CE
    

---

# **Resumen Final del Capítulo**

Este capítulo presentó:

### **VRF-Lite**

- Segmentación local sin MPLS
    
- Tablas de routing independientes
    
- RDs y RTs opcionales en VRF-Lite
    

### **MPLS**

- Conmutación por etiquetas
    
- LIB y LFIB
    
- LDP
    
- LSPs y operaciones push/swap/pop
    
- PHP
    
- MPLS TE usando RSVP-TE
    

### **MPLS L3 VPNs**

- PE-CE routing
    
- Uso de VRFs, RDs, y RTs
    
- MP-BGP transporta rutas VPNv4/VPNv6
    
- Doble etiqueta: transporte + VPN label
    

Dominar estos conceptos es esencial para redes de proveedor, entornos con servicios avanzados y para el examen ENARSI.
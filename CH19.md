# **Capítulo 19 – DMVPN Tunnels**

---

DMVPN (Dynamic Multipoint VPN) es una arquitectura de VPN altamente escalable que combina:

- **GRE** (Generic Routing Encapsulation)
    
- **NHRP** (Next Hop Resolution Protocol)
    
- **IPsec** (opcional, normalmente habilitado)
    

Proporciona conectividad dinámica **spoke-to-spoke**, minimizando dependencias en el hub.

Este capítulo cubre desde GRE básico hasta DMVPN Phase 3, FVRF, IPv6 y troubleshooting.

---

# **1. Generic Routing Encapsulation (GRE) Tunnels**

GRE encapsula paquetes dentro de un nuevo header IP, permitiendo:

- Transporte multiprotocolo (IPv4, IPv6, multicast)
    
- Soporte para routing dinámico
    
- Construcción de topologías virtuales
    

Formato de operación:

```
Original Packet → GRE Header → NEW Outer IP Header → Internet
```

GRE por sí mismo **no cifra**, por eso suele combinarse con IPsec.

---

# **2. GRE Tunnel Configuration**

Configuración básica:

```
interface Tunnel0
 ip address 10.0.0.1 255.255.255.0
 tunnel source GigabitEthernet0/0
 tunnel destination 203.0.113.2
```

Características:

- Es un **túnel punto a punto**
    
- Requiere dirección IP destino estática
    
- No escala bien en topologías Hub-and-Spoke grandes → por eso se usa DMVPN
    

---

# **3. GRE Sample Configuration**

Hub:

```
interface Tunnel0
 ip address 10.0.0.1 255.255.255.0
 tunnel source 198.51.100.1
 tunnel destination 198.51.100.2
```

Spoke:

```
interface Tunnel0
 ip address 10.0.0.2 255.255.255.0
 tunnel source 203.0.113.2
 tunnel destination 198.51.100.1
```

---

# **4. Next Hop Resolution Protocol (NHRP)**

NHRP funciona como un “ARP para redes no broadcast” (NBMA).  
Permite que un spoke descubra dinámicamente la IP pública de otro spoke a través del hub.

NHRP mantiene una **NHRP cache** con:

- Dirección NBMA (pública)
    
- Dirección túnel (privada)
    

Ejemplo:

```
show ip nhrp
```

---

# **5. Dynamic Multipoint VPN (DMVPN)**

DMVPN combina:

- **Multipoint GRE (mGRE)**
    
- **NHRP**
    
- **IPsec opcional**
    

Objetivo: permitir topologías dinámicas y escalables tipo:

- Spoke-to-Hub
    
- Spoke-to-Spoke
    
- Jerarquías (Phase 3)
    

---

# **6. Phase 1: Spoke-to-Hub**

Características:

- mGRE solamente en el hub
    
- GRE punto a punto en cada spoke
    
- Todo tráfico pasa por el hub
    
- No hay comunicación spoke-to-spoke directa
    

Uso típico:

- Redes simples o controladas
    
- Fácil de implementar
    

---

# **7. Phase 2: Spoke-to-Spoke**

Características:

- mGRE en hub y spokes
    
- Spokes construyen túneles dinámicos entre sí
    
- El hub solo participa en descubrimiento
    

Limitación:

- Requiere rutas sin sumarización (prefijos exactos)
    
- No maneja bien supernets o sumarización
    

---

# **8. Phase 3: Hierarchical Tree Spoke-to-Spoke**

La fase más avanzada y escalable:

- mGRE en hub y spokes
    
- Hub provee **redirect** → indica al spoke usar otro spoke
    
- Spokes se conectan dinámicamente mediante **shortcut tunnels**
    
- Maneja **sumarización en spoke y hub**
    

Beneficios:

- Escala masivamente
    
- Menos dependiente del hub
    
- Permite topologías complejas
    

---

# **9. DMVPN Phase Comparison**

|Característica|Phase 1|Phase 2|Phase 3|
|---|---|---|---|
|Hub-and-Spoke|Sí|Sí|Sí|
|Spoke-to-Spoke|No|Sí|Sí|
|Sumarización|No|No|Sí|
|NHRP Redirect|No|No|Sí|
|Lógica de Routing|Simple|Sensible a prefijo|Hierárquico y escalable|

---

# **10. DMVPN Configuration**

Componentes principales:

1. Tunnel Interface (mGRE)
    
2. NHRP configuration
    
3. IP addressing
    
4. IPsec (opcional)
    
5. IGP/BGP para enrutamiento interno
    

---

# **11. DMVPN Hub Configuration**

Ejemplo:

```
interface Tunnel0
 ip address 10.1.0.1 255.255.0.0
 ip nhrp network-id 1
 ip nhrp map multicast dynamic
 tunnel source GigabitEthernet0/0
 tunnel mode gre multipoint
```

---

# **12. DMVPN Spoke Configuration for Phase 1 (Point-to-Point)**

```
interface Tunnel0
 ip address 10.1.1.2 255.255.255.0
 ip nhrp map 10.1.1.1 198.51.100.1
 ip nhrp map multicast 198.51.100.1
 ip nhrp network-id 1
 tunnel source GigabitEthernet0/0
 tunnel destination 198.51.100.1
```

---

# **13. Viewing DMVPN Tunnel Status**

```
show dmvpn
show ip nhrp nhs
show ip nhrp
```

---

# **14. Viewing the NHRP Cache**

```
show ip nhrp
```

Muestra:

- IP del túnel destino
    
- IP pública asociada
    
- Estado de registro
    
- Expiración
    

---

# **15. DMVPN Configuration for Phase 3 (Multipoint)**

Hub Phase 3:

```
interface Tunnel0
 ip address 10.1.0.1 255.255.0.0
 ip nhrp network-id 1
 ip nhrp redirect
 tunnel mode gre multipoint
 tunnel source GigabitEthernet0/0
```

Spoke Phase 3:

```
interface Tunnel0
 ip address 10.1.1.2 255.255.255.0
 ip nhrp network-id 1
 ip nhrp nhs 10.1.0.1
 ip nhrp shortcut
 tunnel mode gre multipoint
 tunnel source GigabitEthernet0/0
```

---

# **16. IP NHRP Authentication**

Para evitar registros falsos:

```
ip nhrp authentication DMVPNKEY
```

Debe coincidir en hub y spokes.

---

# **17. Unique IP NHRP Registration**

Impide que dos spokes usen la misma IP túnel o NBMA:

```
ip nhrp registration no-unique
```

O para forzar unicidad:

```
ip nhrp registration unique
```

---

# **18. Spoke-to-Spoke Communication**

En Phase 2 y 3:

1. Spoke envía tráfico → hub
    
2. Hub responde con su dirección NBMA
    
3. Spokes crean túnel dinámico
    
4. Tráfico fluye directamente
    

En Phase 3, NHRP redirect optimiza este proceso.

---

# **19. Forming Spoke-to-Spoke Tunnels**

Elementos necesarios:

- mGRE en spokes
    
- NHRP nhs configurado
    
- NHRP redirect (Phase 3)
    
- Routing adecuado para prefijos completos o resumidos
    

---

# **20. NHRP Routing Table Manipulation**

Usado para:

- Engañar al spoke para que use atajos
    
- Evitar loops internos
    
- Controlar prefijos en Phase 3
    

Ejemplo:

```
ip nhrp redirect
ip nhrp shortcut
```

---

# **21. NHRP Routing Table Manipulation with Summarization**

En Phase 2 → NO funciona bien  
En Phase 3 → Funciona correctamente gracias a redirect/shortcut

Beneficio:

- Permite supernets en spokes
    
- Evita explosion de prefijos
    
- Optimiza routing dinámico
    

---

# **22. Problems with Overlay Networks**

Problemas típicos:

- **Recursive routing**
    
- **Next-hop incorrecto**
    
- **Falta de rutas hacia NBMA**
    
- **Routing asimétrico**
    

---

# **23. Recursive Routing Problems**

Ocurre cuando:

La ruta al **tunnel destination** apunta al **túnel mismo**.

Ejemplo:

```
tunnel destination 203.0.113.5
ip route 203.0.113.0/24 Tunnel0   ← problema
```

Solución:

- Asegurar rutas correctas mediante FVRF
    
- Usar rutas estáticas o IGP en el VRF físico
    

---

# **24. Outbound Interface Selection**

GRE crea rutas con next-hop internos.  
El router debe saber:

- Qué interfaz física usar para llegar al NBMA
    
- Que el tunnel no debe depender del routing overlay
    

De lo contrario → loop o pérdida de conectividad.

---

# **25. Front Door Virtual Routing and Forwarding (FVRF)**

FVRF separa:

- **Routing del overlay (túnel)**
    
- **Routing del underlay (Internet)**
    

Permite evitar:

- Recursive routing
    
- Fuga de rutas VPN al underlay
    
- Colisiones de prefijos internos/externos
    

---

# **26. Configuring Front Door VRF (FVRF)**

Crear VRF físico:

```
vrf definition FVRF
 address-family ipv4
 exit-address-family
```

Asignar interfaz bajolay:

```
interface GigabitEthernet0/0
 vrf forwarding FVRF
 ip address 198.51.100.10 255.255.255.0
```

Usar VRF del túnel:

```
interface Tunnel0
 tunnel vrf FVRF
```

---

# **27. FVRF Static Routes**

Ejemplo:

```
ip route vrf FVRF 0.0.0.0 0.0.0.0 198.51.100.1
```

Esto asegura que el tráfico del túnel salga correctamente al Internet/underlay.

---

# **28. DMVPN Failure Detection and High Availability**

Incluye:

- NHRP registration timers
    
- Tunnel keepalives
    
- IPsec Dead Peer Detection
    
- NHRP holdtime ajustes
    

---

# **29. DMVPN Hub Redundancy**

Puede configurarse:

- Dual-hub (activo/activo)
    
- Hierarchical DMVPN
    
- Backup tunnels
    

Ejemplo:

```
ip nhrp nhs 10.1.0.1
ip nhrp nhs 10.2.0.1
```

---

# **30. IPv6 DMVPN Configuration**

Requisitos:

- Tunnel IPv6
    
- NHRP compatible IPv6
    
- FVRF opcional
    
- IPsec IPv6 si se usa cifrado
    

---

# **31. IPv6-over-IPv6 Sample Configuration**

Hub:

```
interface Tunnel0
 ipv6 address 2001:db8:1::1/64
 ipv6 nhrp network-id 10
 ipv6 nhrp map multicast dynamic
 tunnel mode gre multipoint
 tunnel source GigabitEthernet0/0
```

Spoke:

```
interface Tunnel0
 ipv6 address 2001:db8:1::2/64
 ipv6 nhrp nhs 2001:db8:1::1
 tunnel mode gre multipoint
 tunnel source GigabitEthernet0/0
```

---

# **32. IPv6 DMVPN Verification**

Comandos:

```
show dmvpn
show ipv6 nhrp
show ipv6 route
show crypto session
```

---

# **Resumen Final del Capítulo**

Este capítulo cubrió toda la arquitectura DMVPN:

### **GRE**

- Encapsulación base
    
- Configuración estática punto a punto
    

### **NHRP**

- Resolución de next-hop
    
- Caches dinámicos
    
- Autenticación
    
- Unique registration
    

### **DMVPN (P1, P2, P3)**

- Multipoint GRE
    
- Túneles dinámicos
    
- NHRP redirect/shortcut
    
- Sumarización (solo Phase 3)
    

### **Overlay Challenges**

- Recursive routing
    
- Outbound interface selection
    
- Necesidad de FVRF
    

### **IPv6 DMVPN**

- NHRP IPv6
    
- Verificación y routing
    

Dominar DMVPN es esencial para el examen ENARSI y para redes seguras y escalables en escenarios empresariales y WAN híbridas.
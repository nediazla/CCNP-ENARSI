# **Capítulo 20 – Securing DMVPN Tunnels**

---

DMVPN por sí mismo **no cifra** el tráfico.  
Para proporcionar confidencialidad, autenticación e integridad, se usa **IPsec**, normalmente junto con **IKEv1 o IKEv2**, según la plataforma.

Este capítulo cubre la arquitectura de seguridad completa para DMVPN, desde IPsec básico hasta implementaciones modernas basadas en IKEv2.

---

# **1. Elements of Secure Transport**

Una solución de transporte seguro debe proveer:

- **Confidencialidad** (evita lectura del tráfico)
    
- **Integridad** (evita manipulación)
    
- **Autenticación** (verifica identidad)
    
- **Protección contra ataques de replay**
    
- **Gestión dinámica de claves (IKE)**
    
- **Resiliencia ante interrupciones (DPD, NAT-Traversal)**
    

DMVPN + IPsec cumple estos requisitos.

---

# **2. IPsec Fundamentals**

IPsec opera en dos grandes componentes:

1. **IKE/IKEv2** → Negocia claves y parámetros de seguridad
    
2. **IPsec (AH/ESP)** → Protege la data (cifra/integra)
    

IPsec asegura tráfico IP mediante:

- Cifrado
    
- Integridad
    
- Autenticación
    
- Control de flujo
    
- Protecciones anti-replay
    

---

# **3. Security Protocols**

IPsec usa dos protocolos principales:

- **Authentication Header (AH)**
    
- **Encapsulating Security Payload (ESP)**
    

---

# **4. Authentication Header (AH)**

Proporciona:

- Autenticación
    
- Integridad
    
- Protección anti-replay
    

**Pero NO cifra**, por lo que rara vez se usa.

Formato: autenticación + integridad del paquete IP completo (incluyendo cabecera).

---

# **5. Encapsulating Security Payload (ESP)**

ESP ofrece:

- **Cifrado (confidencialidad)**
    
- Autenticación (opcional)
    
- Integridad
    
- Protección anti-replay
    

ESP es la opción principal para DMVPN porque cifra el paquete transportado dentro del túnel GRE/mGRE.

---

# **6. Key Management**

IKEv1/IKEv2 negocia parámetros:

- Algoritmos de cifrado
    
- Algoritmos de integridad
    
- Métodos de autenticación
    
- Tiempos de vida de Security Associations (SA)
    
- Intercambio de claves Diffie-Hellman (DH)
    

---

# **7. Security Associations (SA)**

Una SA define:

- Hash
    
- Cifrado
    
- Tiempo de vida
    
- Dirección del peer
    
- SPI (Security Parameter Index)
    

Las SA son unidireccionales → se necesitan dos por túnel (inbound/outbound).

Verificación:

```
show crypto ipsec sa
show crypto isakmp sa
show crypto ikev2 sa
```

---

# **8. ESP Modes**

ESP puede operar en:

### **Tunnel Mode**

- Encapsula completamente el paquete IP original
    
- Añade nueva cabecera IP
    
- Más seguro
    
- **Recomendado para túneles site-to-site y DMVPN**
    

### **Transport Mode**

- Solo cifra la carga, preserva la cabecera IP original
    
- Usado en DMVPN Phase 1 y Phase 3 si la encapsulación GRE está antes del cifrado
    

---

# **9. DMVPN Without IPsec**

Es completamente funcional pero **no seguro**.  
Solo se usa en entornos de laboratorio.

```
interface Tunnel0
 tunnel mode gre multipoint
```

---

# **10. DMVPN with IPsec in Transport Mode**

Transport mode cifra únicamente el GRE payload:

```
tunnel protection ipsec profile DMVPN-PROFILE transport
```

Características:

- Menor overhead
    
- Más eficiente
    
- Dependiente de que GRE encapsule primero
    

---

# **11. DMVPN with IPsec in Tunnel Mode**

Tunnel mode cifra:

- cabecera IP original
    
- GRE
    
- Datos
    

```
tunnel protection ipsec profile DMVPN-PROFILE
```

Más seguro, más compatible, más overhead.

---

# **12. IPsec Tunnel Protection**

Método moderno para asegurar DMVPN:

```
interface Tunnel0
 tunnel protection ipsec profile DMVPN-PROFILE
```

Permite:

- IPsec aplicado directamente al túnel
    
- No requiere crypto maps
    
- Funciona para mGRE y Phase 1/2/3
    

---

# **13. Pre-Shared Key Authentication**

IKE usa llaves precompartidas:

```
crypto isakmp key MYPRESHAREDKEY address 0.0.0.0 0.0.0.0
```

En IKEv2 se usa un keyring (mejor práctica).

---

# **14. IKEv2 Keyring**

Define credenciales de los peers:

```
crypto ikev2 keyring DMVPN-KEYRING
 peer SPOKES
  address 0.0.0.0 0.0.0.0
  pre-shared-key cisco123
```

---

# **15. IKEv2 Profile**

Asocia identidad, keyring y parámetros:

```
crypto ikev2 profile DMVPN-PROFILE
 match identity remote address 0.0.0.0
 authentication remote pre-share
 authentication local pre-share
 keyring local DMVPN-KEYRING
```

---

# **16. IPsec Transform Set**

Define cómo se protege el tráfico:

```
crypto ipsec transform-set ESP-AES-SHA esp-aes 256 esp-sha-hmac
```

---

# **17. IPsec Profile**

Agrega transform sets + configuración IKEv2:

```
crypto ipsec profile DMVPN-PROFILE
 set transform-set ESP-AES-SHA
 set ikev2-profile DMVPN-PROFILE
```

---

# **18. Encrypting the Tunnel Interface**

```
interface Tunnel0
 tunnel protection ipsec profile DMVPN-PROFILE
```

Con esto:

- El GRE/mGRE está protegido
    
- Cada spoke genera SA dinámicamente
    
- Escalabilidad masiva en Phase 2 y 3
    

---

# **19. IPsec Packet Replay Protection**

Protección activada por defecto:

- Cada paquete tiene un número de secuencia
    
- Si se repite → es descartado
    

Evita ataques de reproducción.

---

# **20. Dead Peer Detection (DPD)**

DPD detecta túneles que ya no están activos:

```
crypto ikev2 dpd 10 5 on-demand
```

Evita esperas largas tras fallos de spoke.

---

# **21. NAT Keepalives**

NAT-T mantiene vivos túneles cuando hay NAT tipo PAT:

```
crypto isakmp nat keepalive 20
```

En IKEv2 NAT-T se activa automáticamente.

---

# **22. Complete IPsec DMVPN Configuration with Pre-Shared Authentication**

### **Hub**

```
crypto ikev2 keyring DMVPN-KEYRING
 peer SPOKES
  address 0.0.0.0
  pre-shared-key cisco123

crypto ikev2 profile DMVPN-IKE
 match identity remote address 0.0.0.0
 authentication remote pre-share
 authentication local pre-share
 keyring local DMVPN-KEYRING

crypto ipsec transform-set ESP-AES-SHA esp-aes 256 esp-sha-hmac

crypto ipsec profile DMVPN-IPSEC
 set transform-set ESP-AES-SHA
 set ikev2-profile DMVPN-IKE

interface Tunnel0
 ip address 10.1.0.1 255.255.255.0
 tunnel mode gre multipoint
 tunnel source GigabitEthernet0/0
 ip nhrp network-id 1
 ip nhrp redirect
 tunnel protection ipsec profile DMVPN-IPSEC
```

### **Spoke**

```
crypto ikev2 keyring DMVPN-KEYRING
 peer HUB
  address 198.51.100.1
  pre-shared-key cisco123

crypto ikev2 profile DMVPN-IKE
 match identity remote address 198.51.100.1
 authentication remote pre-share
 authentication local pre-share
 keyring local DMVPN-KEYRING

crypto ipsec profile DMVPN-IPSEC
 set transform-set ESP-AES-SHA
 set ikev2-profile DMVPN-IKE

interface Tunnel0
 ip address 10.1.1.2 255.255.255.0
 tunnel mode gre multipoint
 tunnel source GigabitEthernet0/1
 ip nhrp network-id 1
 ip nhrp nhs 10.1.0.1
 ip nhrp shortcut
 tunnel protection ipsec profile DMVPN-IPSEC
```

---

# **23. Verifying Encryption on DMVPN Tunnels**

Comandos:

```
show dmvpn
show crypto ikev2 sa
show crypto ipsec sa
show crypto sockets
show crypto ikev2 stats

```

Verificaciones clave:

- SA establecidas
    
- Paquetes cifrados y descifrados
    
- No hay replay drops
    

---

# **24. IKEv2 Protection**

IKEv2 proporciona:

- Mejor rendimiento
    
- Menos mensajes (cuatro en total)
    
- Manejo nativo de NAT-T
    
- Mecanismos claros de identidad
    
- Parametrización modular con perfiles
    

Por eso es la opción recomendada para DMVPN moderno.

---

# **Resumen Final del Capítulo**

Este capítulo explica cómo asegurar DMVPN usando IPsec y IKEv2:

### **Fundamentos de Seguridad**

- AH vs ESP
    
- Modos transport y tunnel
    
- Protección anti-replay
    
- DPD y NAT-T
    

### **Componentes de Configuración**

- Keyrings
    
- IKEv2 profiles
    
- Transform sets
    
- IPsec profiles
    
- Tunnel protection
    

### **DMVPN Seguro**

- Phase 1 / Phase 2 / Phase 3 con IPsec
    
- Túneles dinámicos protegidos
    
- Escalabilidad con múltiples spokes
    

### **Diagnóstico**

- Validación de SAs
    
- Revisar cifrado en GRE
    
- Verificación NHRP y mGRE
    

Dominar esto te da la capacidad de desplegar WANs seguras y escalables, exactamente lo que evalúa ENARSI.
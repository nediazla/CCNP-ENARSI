# **Capítulo 22 – Infrastructure Security**

---

Este capítulo aborda técnicas de endurecimiento (hardening) del plano de control y seguridad de infraestructura.  
Incluye AAA, uRPF, CoPP y las funciones esenciales de **IPv6 First-Hop Security**.  
Estos mecanismos protegen a los dispositivos de ataques comunes como spoofing, inundaciones, manipulación de RA/DHCPv6 y control-plane DoS.

---

# **1. Cisco IOS AAA Troubleshooting**

AAA = Authentication, Authorization, Accounting.

Problemas típicos:

- Orden incorrecto en método AAA
    
- Timeouts con servidores RADIUS/TACACS+
    
- Usuario bloqueado por policy
    
- Fallback a local no configurado
    
- Líneas VTY no están asociadas al método AAA
    

Ejemplo de configuración correcta:

```
aaa new-model
aaa authentication login default group radius local
aaa authorization exec default group radius local
aaa accounting exec default start-stop group radius
```

Errores comunes:

- Falta el método `local` → se bloquea acceso si falla el servidor
    
- Configuración en VTY no coincide:
    

```
line vty 0 4
 login authentication default
```

Diagnóstico:

```
debug aaa authentication
debug radius
debug tacacs
```

---

# **2. Troubleshooting Unicast Reverse Path Forwarding (uRPF)**

uRPF evita ataques de spoofing comprobando si el **paquete entrante** tiene una **ruta válida de retorno**.

Modos:

### **Strict Mode**

La ruta hacia la IP origen debe entrar _por la misma interfaz_.

```
ip verify unicast source reachable-via rx
```

### **Loose Mode**

La red origen debe existir en la tabla de rutas, sin importar interfaz.

```
ip verify unicast source reachable-via any
```

Problemas comunes:

- Asimetría en el routing → uRPF strict descartará tráfico válido
    
- Rutas faltantes en RIB
    
- VRF incorrecto
    

Verificación:

```
show cef drop
show ip verify source
```

---

# **3. Troubleshooting Control Plane Policing (CoPP)**

CoPP protege el **control-plane** contra ataques DoS filtrando y rate-limitando tráfico dirigido al router.

Fallos en CoPP pueden:

- Bloquear OSPF/BGP
    
- Evitar acceso SSH
    
- Detener ICMP necesario
    
- Romper NTP, SNMP u otros protocolos
    

---

# **4. Creating ACLs to Identify the Traffic**

Paso 1 para CoPP: identificar tráfico crítico.

Ejemplo:

```
ip access-list extended ICMP-CP
 permit icmp any any echo
 permit icmp any any echo-reply
```

ACLs deben ser **exactas**, especialmente para IGPs:

```
permit ospf any any
permit tcp any eq 179 any   (BGP)
```

Errores típicos:

- Falta de permit para tráfico de routing
    
- Excesivo “deny any” que afecta tráfico del control-plane
    

---

# **5. Creating Class Maps to Define a Traffic Class**

```
class-map match-any CONTROL-ICMP
 match access-group name ICMP-CP
```

---

# **6. Creating Policy Maps to Define a Service Policy**

```
policy-map CONTROL-PLANE-POLICY
 class CONTROL-ICMP
  police 100000 conform-action transmit exceed-action drop
```

Errores comunes:

- Demasiado bajo el rate-limit
    
- Clases sin acción definida
    
- Faltan clases para protocolos de routing
    

---

# **7. Applying the Service Policy to the Control Plane**

```
control-plane
 service-policy input CONTROL-PLANE-POLICY
```

Verificación:

```
show policy-map control-plane
show policy-map interface control-plane
```

---

# **8. CoPP Summary**

CoPP protege:

- BGP
    
- OSPF
    
- ICMP
    
- SSH/HTTPS
    
- SNMP
    
- NTP
    

Buenas prácticas:

- Permitir explícitamente el tráfico de routing
    
- Ajustar rates de acuerdo al tamaño de la red
    
- Usar `class-default drop` para tráfico no identificado
    

---

# **9. IPv6 First-Hop Security**

IPv6 introduce nuevos riesgos:

- Spoofing de Neighbor Discovery
    
- RA falsos
    
- Servidores DHCPv6 no autorizados
    
- Ataques SLAAC
    
- Ataques al binding table
    

Para resolverlos Cisco introduce mecanismos FHS (First-Hop Security):

- Binding Table
    
- IPv6 Snooping
    
- RA Guard
    
- DHCPv6 Guard
    
- Source Guard
    
- Destination Guard
    
- Prefix Guard
    

---

# **10. Binding Table**

Es la base de datos que mantiene:

- IPv6 address
    
- MAC address
    
- Interface
    
- VLAN
    
- Prefix
    
- Lifetimes
    

Generada por:

- **ND Snooping**
    
- **DHCPv6 Snooping**
    
- Estáticos manuales
    

Verificación:

```
show ipv6 source binding
```

---

# **11. IPv6 Snooping**

Aprende dinámicamente bindings válidos evitando spoofing.

Activación:

```
ipv6 snooping
```

Crea bindings para:

- ND
    
- DHCPv6
    
- RA mensajes válidos
    

Problemas típicos:

- Switch no soporta snooping
    
- Falta de trust en puertos trunk
    
- No se generan bindings → Source Guard bloquea tráfico
    

---

# **12. Router Advertisement (RA) Guard**

Evita que un atacante envíe RA falsos que anuncian:

- Gateways incorrectos
    
- Prefijos falsos
    
- Flags M/O para manipular DHCPv6
    
- Ataques SLAAC
    

Configuración:

```
ipv6 nd raguard policy RA-POLICY
 device-role host

interface Gig1/0/10
 ipv6 nd raguard attach-policy RA-POLICY
```

---

# **13. DHCPv6 Guard**

Bloquea DHCPv6 server no autorizado.

```
ipv6 dhcp guard policy DHCP6-POLICY
 device-role client

interface Gig1/0/20
 ipv6 dhcp guard attach-policy DHCP6-POLICY
```

Evita que rogue servers entreguen direcciones.

---

# **14. Source Guard**

Verifica que la IP origen coincide con:

- Binding table
    
- MAC
    
- VLAN
    
- Interfaz
    

Si no coincide → DROP.

```
ipv6 source-guard
```

Problemas comunes:

- Falta binding table → todo se bloquea
    
- Clientes con direcciones privacy extensions
    

---

# **15. Destination Guard**

Verifica que la IP destino sea válida en la red segmentada:

```
ipv6 destination-guard attach-policy DEFAULT
```

Evita que hosts intenten enviar tráfico a destinos inexistentes (scan masivo).

---

# **16. Prefix Guard**

Evita la introducción de prefijos falsos en la LAN:

```
ipv6 prefix-guard
```

Protege contra:

- Falsos RAs
    
- Ataques que anuncian prefijos no autorizados
    
- SLAAC poisoning
    

---

# **Resumen Final del Capítulo**

Este capítulo cubre los pilares de la seguridad de infraestructura:

### **AAA**

- Autenticación segura
    
- Troubleshooting con debug y fallback
    

### **uRPF**

- Prevención de spoofing
    
- Modos strict y loose
    
- Problemas de asimetría
    

### **Control Plane Policing (CoPP)**

- Protección del plano de control
    
- ACLs, class-maps, policy-maps
    
- Errores comunes al filtrar protocolos de routing
    

### **IPv6 First-Hop Security**

- Binding table como base
    
- ND/DHCPv6 snooping
    
- RA Guard
    
- DHCPv6 Guard
    
- Source/Destination Guard
    
- Prefix Guard
    

Dominar estos mecanismos es vital para diseñar redes seguras y para aprobar ENARSI.